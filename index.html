<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Crane Hunt - Fixed Trails + Optimized</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
  
    <!--  Google Fonts link -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredericka+the+Great&display=swap" rel="stylesheet">
  
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: Roboto, sans-serif; 
      width:100vw; 
      height:100vh; 
      overflow:hidden; 
      background:#0a0e27; 
      position:relative; 
    }
    body::before{
      content:''; 
      position:fixed; 
      top:-50%; 
      left:-50%; 
      width:200%; 
      height:200%;
      background:
        radial-gradient(circle at 20% 50%, rgba(102,126,234,0.4) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(240,147,251,0.4) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(79,172,254,0.4) 0%, transparent 50%),
        radial-gradient(circle at 90% 20%, rgba(0,242,254,0.4) 0%, transparent 50%);
      animation: swirl1 20s linear infinite; 
      z-index:0; 
      pointer-events:none;
    }
    body::after{
      content:''; 
      position:fixed; 
      top:-50%; 
      left:-50%; 
      width:200%; 
      height:200%;
      background:
        radial-gradient(circle at 50% 50%, rgba(118,75,162,0.3) 0%, transparent 60%),
        radial-gradient(circle at 60% 40%, rgba(240,147,251,0.3) 0%, transparent 60%);
      animation: swirl2 30s linear infinite; 
      z-index:0; 
      pointer-events:none;
    }
    
    @keyframes swirl1 { 
      from { 
        transform: rotate(0deg); 
      } to {
        transform: rotate(360deg); 
      } 
    }
    @keyframes swirl2 { 
      from { 
        transform: rotate(360deg); 
      } to {
        transform: rotate(0deg); 
      } 
    }

    #p5-container { 
      position:fixed; 
      top:0; 
      left:0; 
      width:100vw; 
      height:100vh; 
      z-index:1; 
      pointer-events:none; 
    }
    
    #p5-container canvas { 
      display:block; 
      background:transparent !important; 
    }

    #counter { 
      position:fixed;
      transform: translateX(-50%);
      top:20px; 
      left:50%;
      z-index:2; 
      color:white; 
      font-size:62px; 
      text-shadow:2px 2px 4px rgba(0,0,0,0.3);
      font-family: 'Fredericka the Great';
    }
    
    .controls-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2;
      display: flex;
      gap: 12px;
      transition: opacity 0.3s ease;
    }

    .controls-container.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    #fullscreen-btn, #audio-btn { 
      background:rgba(255,255,255,0.9); 
      border:none; 
      border-radius:8px; 
      padding:12px 18px; 
      font-size:16px; 
      font-weight:600; 
      color:#667eea; 
      cursor:pointer; 
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      transition: all 0.2s ease;
    }

    #fullscreen-btn:hover, #audio-btn:hover {
      background:rgba(255,255,255,1);
      box-shadow:0 6px 16px rgba(0,0,0,0.3);
    }

    #fullscreen-btn:active, #audio-btn:active {
      transform: scale(0.98);
    }
    
    #message-box { 
      position:fixed; 
      top:50%; 
      left:50%; 
      transform:translate(-50%,-50%); 
      z-index:0; 
      text-align:center; 
      pointer-events:none; 
    }
    
    #message-text { 
      font-size:120px; 
      font-weight:900; 
      letter-spacing:8px; 
      color:rgba(149,255,234,0.495); 
      font-family:'Fredericka the Great'; 
      text-shadow:2px 2px 8px rgba(0,0,0,0.5); 
      line-height:1.2; max-width:90vw; 
    }
    
  </style>
</head>
<body>
  <div id="counter" class="loading">Loading cranes...</div>
  <div class="controls-container">
    <button id="audio-btn">ðŸ”Š Play</button>
    <button id="fullscreen-btn">â›¶ Fullscreen</button>
  </div>
  <div id="p5-container"></div>
  <div id="message-box"><div id="message-text">_</div></div>

  <script>
/* -------------------------
   Config
   ------------------------- */
const MAX_VISIBLE_CRANES = 80;
const PRE_TINT_COUNT = 12;
const BASE_SPRITE_SIZE = 220;
const MIN_CRANE_SIZE = 190;
const MAX_CRANE_SIZE = 420;
const POLL_INTERVAL_MS = 3000;

/* -------------------------
   Globals
   ------------------------- */
let totalFound = 0;
let message = "";
let cranes = [];
let audioContext = null;
let pInstance = null;
let lastCheckedTotal = 0;
let pollingInterval = null;

let craneImg = null;
let preTinted = [];

// Audio globals
let audioBuffer = null;
let audioSource = null;
let isPlaying = false;
let audioGain = null;

// Completion audio
let completionAudioBuffer = null;
let completionAudioPlayed = false;

// Cursor visibility timer
let cursorHideTimer = null;
const controlsContainer = document.querySelector('.controls-container');
const HIDE_DELAY = 3000;

/* -------------------------
   Cursor visibility handler
   ------------------------- */
function showControls() {
  controlsContainer.classList.remove('hidden');
  
  clearTimeout(cursorHideTimer);
  cursorHideTimer = setTimeout(() => {
    controlsContainer.classList.add('hidden');
  }, HIDE_DELAY);
}

document.addEventListener('mousemove', showControls);
document.addEventListener('mouseenter', showControls);

// Show controls on page load
showControls();

/* -------------------------
   Audio Button
   ------------------------- */
const audioBtn = document.getElementById('audio-btn');
audioBtn.addEventListener('click', toggleAudio);

function toggleAudio() {
  if (isPlaying) {
    pauseAudio();
  } else {
    playAudio();
  }
}

async function playAudio() {
  try {
    initAudio();
    
    if (!audioBuffer) {
      console.warn("Audio buffer not loaded");
      return;
    }

    if (audioSource) {
      audioSource.stop();
    }

    audioSource = audioContext.createBufferSource();
    audioSource.buffer = audioBuffer;
    audioSource.loop = false;
    
    if (!audioGain) {
      audioGain = audioContext.createGain();
      audioGain.gain.value = 1.8;
      audioGain.connect(audioContext.destination);
    }

    audioSource.connect(audioGain);
    audioSource.start(0);
    isPlaying = true;
    audioBtn.textContent = 'â¸ Pause';
  } catch (e) {
    console.error("Error playing audio:", e);
  }
}

function pauseAudio() {
  try {
    if (audioSource) {
      audioSource.stop();
      audioSource = null;
    }
    isPlaying = false;
    audioBtn.textContent = 'ðŸ”Š Play';
  } catch (e) {
    console.error("Error pausing audio:", e);
  }
}

async function loadAudioFile(url) {
  try {
    initAudio();
    const response = await fetch(url);
    const arrayBuffer = await response.arrayBuffer();
    audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
    console.log("Audio loaded successfully");
  } catch (e) {
    console.error("Error loading audio:", e);
  }
}

async function loadCompletionAudio(url) {
  try {
    initAudio();
    const response = await fetch(url);
    const arrayBuffer = await response.arrayBuffer();
    completionAudioBuffer = await audioContext.decodeAudioData(arrayBuffer);
    console.log("Completion audio loaded successfully");
  } catch (e) {
    console.error("Error loading completion audio:", e);
  }
}

function playCompletionAudio() {
  try {
    initAudio();
    
    if (!completionAudioBuffer) {
      console.warn("Completion audio buffer not loaded");
      return;
    }

    const completionSource = audioContext.createBufferSource();
    completionSource.buffer = completionAudioBuffer;
    completionSource.connect(audioContext.destination);
    completionSource.start(0);
    console.log("Completion audio playing");
  } catch (e) {
    console.error("Error playing completion audio:", e);
  }
}

/* Fullscreen button */
const fullscreenBtn = document.getElementById('fullscreen-btn');
fullscreenBtn.addEventListener('click', toggleFullscreen);
function toggleFullscreen() {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>console.error(e));
  else document.exitFullscreen();
}
document.addEventListener('fullscreenchange', ()=> {
  fullscreenBtn.textContent = document.fullscreenElement ? 'â›¶ Exit Fullscreen' : 'â›¶ Fullscreen';
});

    
/* -------------------------
   AUTO-START BACKGROUND MUSIC
   ------------------------- */

let bgmBuffer = null;
let bgmSource = null;
let bgmGain = null;

async function loadBGM(url) {
  initAudio();
  const res = await fetch(url);
  const buf = await res.arrayBuffer();
  bgmBuffer = await audioContext.decodeAudioData(buf);
  console.log("BGM loaded");
}

function startBGM() {
  if (!bgmBuffer) return;

  if (!bgmGain) {
    bgmGain = audioContext.createGain();
    bgmGain.gain.value = 1.0;        // normal volume
    bgmGain.connect(audioContext.destination);
  }

  if (bgmSource) {
    bgmSource.stop();
    bgmSource = null;
  }

  bgmSource = audioContext.createBufferSource();
  bgmSource.buffer = bgmBuffer;
  bgmSource.loop = true;

  bgmSource.connect(bgmGain);
  bgmSource.start(0);

  console.log("BGM started");
}

// Start BGM after the FIRST user interaction
function enableAutoBGM() {
  const handler = () => {
    startBGM();
    window.removeEventListener("click", handler);
    window.removeEventListener("touchstart", handler);
    window.removeEventListener("keydown", handler);
  };
  window.addEventListener("click", handler);
  window.addEventListener("touchstart", handler);
  window.addEventListener("keydown", handler);
}

    
function playDramaticDing() {
  try {
    initAudio();
    const now = audioContext.currentTime;

    // Master gain for overall volume control
    const masterGain = audioContext.createGain();
    masterGain.gain.setValueAtTime(0.6, now);
    masterGain.connect(audioContext.destination);

    // Layer 1: main bell
    const osc1 = audioContext.createOscillator();
    const gain1 = audioContext.createGain();
    osc1.type = "sine";
    osc1.frequency.setValueAtTime(400, now);
    osc1.frequency.exponentialRampToValueAtTime(800, now + 0.8); // gentle pitch rise
    gain1.gain.setValueAtTime(0, now);
    gain1.gain.linearRampToValueAtTime(0.4, now + 0.02); // smooth attack
    gain1.gain.exponentialRampToValueAtTime(0.001, now + 2); // slow elegant decay
    osc1.connect(gain1);
    gain1.connect(masterGain);

    // Layer 2: higher harmonic for sparkle
    const osc2 = audioContext.createOscillator();
    const gain2 = audioContext.createGain();
    osc2.type = "sine";
    osc2.frequency.setValueAtTime(600, now);
    osc2.frequency.exponentialRampToValueAtTime(1200, now + 0.8);
    gain2.gain.setValueAtTime(0, now);
    gain2.gain.linearRampToValueAtTime(0.2, now + 0.02);
    gain2.gain.exponentialRampToValueAtTime(0.001, now + 2);
    osc2.connect(gain2);
    gain2.connect(masterGain);

    // Layer 3: subtle low resonance for drama
    const osc3 = audioContext.createOscillator();
    const gain3 = audioContext.createGain();
    osc3.type = "sine";
    osc3.frequency.setValueAtTime(250, now);
    gain3.gain.setValueAtTime(0, now);
    gain3.gain.linearRampToValueAtTime(0.15, now + 0.02);
    gain3.gain.exponentialRampToValueAtTime(0.001, now + 2);
    osc3.connect(gain3);
    gain3.connect(masterGain);

    // Start & stop oscillators
    osc1.start(now); osc2.start(now); osc3.start(now);
    osc1.stop(now + 2); osc2.stop(now + 2); osc3.stop(now + 2);
  } catch (e) {
    console.warn("Audio error:", e);
  }
}

    
function fadeOutBGM(duration = 300000) {
  if (!bgmGain) return;

  const now = audioContext.currentTime;
  bgmGain.gain.cancelScheduledValues(now);
  bgmGain.gain.setValueAtTime(bgmGain.gain.value, now);
  bgmGain.gain.linearRampToValueAtTime(0, now + duration / 1000);
}

    
    
/* -------------------------
   Fetching crane status
   ------------------------- */
async function fetchCraneData(){
  try {
    const response = await fetch(`https://script.google.com/macros/s/AKfycbwD0M9v9_pUxJ8Fr5Bxz0X2U5AqUI0ZolvVpoCGZlDSDERtGMzbB3MyuBiYbxmi79IFiQ/exec?action=getStatus`);
    const data = await response.json();
    totalFound = data.totalFound || 0;
    message = data.message || "";

    if (totalFound > lastCheckedTotal && pInstance) {
      const newCranes = totalFound - lastCheckedTotal;
      for (let i = 0; i < newCranes; i++) {
        if (cranes.length < MAX_VISIBLE_CRANES) {
          cranes.push(new Crane(
            pInstance,
            pInstance.random(pInstance.width),
            pInstance.random(pInstance.height),
            pInstance.random(0.6, 2.2)
          ));
          playBeautifulChime();
        }
      }
      lastCheckedTotal = totalFound;
    }

  // Check if all 35 characters have been found
  if (totalFound === 35 && !completionAudioPlayed) {
    completionAudioPlayed = true;

    // Play dramatic ding first
    playDramaticDing();

    // Slight delay before playing the main completion audio
    setTimeout(() => {
      playCompletionAudio();
      fadeOutBGM(30000);  // fade duration in ms  
      
    }, 500); // 500ms delay to let the dramatic ding be heard
  }

    document.getElementById('counter').textContent = `Cranes Found: ${totalFound} / 35`;
    document.getElementById('message-text').textContent = message || "...";

    if (!pInstance) initSketch();
  } catch (err) {
    console.error("Error fetching data:", err);
    if (!pInstance) {
      document.getElementById('counter').textContent = "Error loading data. Using demo mode.";
      totalFound = 25;
      message = "CRANES BRING JOY";
      initSketch();
    }
  }
}
function startPolling(){
  if (pollingInterval) clearInterval(pollingInterval);
  pollingInterval = setInterval(fetchCraneData, POLL_INTERVAL_MS);
}

/* -------------------------
   Audio helpers
   ------------------------- */
function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function playBeautifulChime() {
  try {
    initAudio();
    const now = audioContext.currentTime;
    
    const osc1 = audioContext.createOscillator();
    const gain1 = audioContext.createGain();
    osc1.type = "sine";
    osc1.frequency.value = 784;
    
    const osc2 = audioContext.createOscillator();
    const gain2 = audioContext.createGain();
    osc2.type = "sine";
    osc2.frequency.value = 1175;
    
    const osc3 = audioContext.createOscillator();
    const gain3 = audioContext.createGain();
    osc3.type = "sine";
    osc3.frequency.value = 1976;
    
    const masterGain = audioContext.createGain();
    
    gain1.gain.setValueAtTime(0.15, now);
    gain1.gain.exponentialRampToValueAtTime(0.02, now + 0.8);
    
    gain2.gain.setValueAtTime(0, now);
    gain2.gain.linearRampToValueAtTime(0.12, now + 0.05);
    gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.9);
    
    gain3.gain.setValueAtTime(0, now);
    gain3.gain.linearRampToValueAtTime(0.08, now + 0.1);
    gain3.gain.exponentialRampToValueAtTime(0.005, now + 1.2);
    
    masterGain.gain.setValueAtTime(1, now);
    masterGain.gain.exponentialRampToValueAtTime(0.01, now + 1.3);
    
    osc1.connect(gain1);
    osc2.connect(gain2);
    osc3.connect(gain3);
    
    gain1.connect(masterGain);
    gain2.connect(masterGain);
    gain3.connect(masterGain);
    
    masterGain.connect(audioContext.destination);
    
    osc1.start(now);
    osc2.start(now);
    osc3.start(now);
    
    osc1.stop(now + 0.85);
    osc2.stop(now + 0.95);
    osc3.stop(now + 1.3);
  } catch (e) {
    console.warn("Audio error:", e);
  }
}

function playSound(freq = 400, duration = 80) {
  try {
    initAudio();
    const osc = audioContext.createOscillator();
    const g = audioContext.createGain();
    osc.type = "sine";
    osc.frequency.value = freq;
    g.gain.setValueAtTime(0.0001, audioContext.currentTime);
    g.gain.exponentialRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + duration/1000);
    osc.connect(g);
    g.connect(audioContext.destination);
    osc.start();
    osc.stop(audioContext.currentTime + duration/1000 + 0.02);
  } catch (e) {
    console.warn("Audio error:", e);
  }
}

/* -------------------------
   Color helper: HSL -> RGB
   ------------------------- */
function hslToRgb(h, s, l) {
  h /= 360; s /= 100; l /= 100;
  if (s === 0) {
    const v = Math.round(l * 255);
    return [v, v, v];
  }
  const hue2rgb = (p, q, t) => {
    if (t < 0) t += 1;
    if (t > 1) t -= 1;
    if (t < 1/6) return p + (q - p) * 6 * t;
    if (t < 1/2) return q;
    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
    return p;
  };
  const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
  const p = 2 * l - q;
  const r = Math.round(hue2rgb(p, q, h + 1/3) * 255);
  const g = Math.round(hue2rgb(p, q, h) * 255);
  const b = Math.round(hue2rgb(p, q, h - 1/3) * 255);
  return [r, g, b];
}

/* -------------------------
   Sketch boot (preload + setup)
   ------------------------- */
function initSketch(){
  new p5((p) => {
    pInstance = p;
    p.preload = function() {
      craneImg = p.loadImage('images/crane.png');
    };
    p.setup = function() {
      const canvas = p.createCanvas(window.innerWidth, window.innerHeight);
      canvas.parent('p5-container');
      p.noStroke();
      p.frameRate(55);

      if (craneImg) preparePreTintedSprites(p);

      for (let i = 0; i < Math.min(totalFound, MAX_VISIBLE_CRANES); i++) {
        cranes.push(new Crane(p, p.random(p.width), p.random(p.height), p.random(0.6, 2.2)));
      }
      lastCheckedTotal = totalFound;
      startPolling();
    };

    p.draw = function() {
      p.clear();

      for (let i = 0, n = cranes.length; i < n; i++) {
        cranes[i].update(p.width, p.height);
        cranes[i].display(p);
      }
    };

    p.windowResized = function() {
      p.resizeCanvas(window.innerWidth, window.innerHeight);
    };
  });
}

/* -------------------------
   PRE-TINT: manual pixel multiply
   ------------------------- */
function preparePreTintedSprites(p) {
  preTinted.length = 0;

  for (let i = 0; i < PRE_TINT_COUNT; i++) {
    const hue = (i / PRE_TINT_COUNT) * 360;
    const [rTint, gTint, bTint] = hslToRgb(hue, 70, 75);

    const gsize = Math.round(BASE_SPRITE_SIZE);
    const gfx = p.createGraphics(gsize, gsize);
    gfx.pixelDensity(1);
    gfx.clear();
    gfx.imageMode(p.CENTER);

    gfx.push();
    gfx.translate(gfx.width / 2, gfx.height / 2);
    gfx.image(craneImg, 0, 0, gfx.width, gfx.height);
    gfx.pop();

    gfx.loadPixels();
    const px = gfx.pixels;
    for (let pi = 0; pi < px.length; pi += 4) {
      const a = px[pi + 3];
      if (a === 0) continue;

      px[pi + 0] = Math.round((px[pi + 0] * rTint) / 255);
      px[pi + 1] = Math.round((px[pi + 1] * gTint) / 255);
      px[pi + 2] = Math.round((px[pi + 2] * bTint) / 255);
    }
    gfx.updatePixels();

    preTinted.push(gfx);
  }
}

/* -------------------------
   Crane class (fast)
   ------------------------- */
class Crane {
  constructor(p, x, y, speed) {
    this.p = p;
    this.x = x;
    this.y = y;
    this.vx = p.random(-speed, speed);
    this.vy = p.random(-speed, speed);
    this.speed = speed;
    this.size = p.random(MIN_CRANE_SIZE, MAX_CRANE_SIZE);
    this.rotation = p.random(p.TWO_PI);
    this.hueShift = p.random(360);
    this.spriteIndex = Math.floor((this.hueShift / 360) * PRE_TINT_COUNT) % PRE_TINT_COUNT;
    this.lastBounceSound = 0;
    this.bounceCooldown = 120;
  }

  update(w, h) {
    this.x += this.vx;
    this.y += this.vy;

    let now = performance.now();
    let hit = false;

    if (this.x < 0) { this.vx *= -1; this.x = 0; hit = true; }
    else if (this.x > w) { this.vx *= -1; this.x = w; hit = true; }

    if (this.y < 0) { this.vy *= -1; this.y = 0; hit = true; }
    else if (this.y > h) { this.vy *= -1; this.y = h; hit = true; }

    if (hit && (now - this.lastBounceSound > this.bounceCooldown)) {
      playSound(480 + Math.random() * 200, 70);
      this.lastBounceSound = now;
    }

    this.rotation += 0.01 * (0.5 + this.speed);
  }

  display(p) {
    p.push();
    p.translate(this.x, this.y);
    p.rotate(this.rotation);
    p.imageMode(p.CENTER);

    const gfx = preTinted[this.spriteIndex];
    if (gfx) {
      p.image(gfx, 0, 0, this.size, this.size);
    } else {
      p.fill(255, 200, 220);
      p.noStroke();
      p.ellipse(0, 0, this.size * 0.7, this.size * 0.7);
    }
    p.pop();
  }
}
    
    
// Load background music file
loadBGM("sounds/bgm_aFondMemory.mp3");

// Enable auto-start on first interaction
enableAutoBGM();

// Load completion audio file
loadCompletionAudio("sounds/completion.mp3");


/* -------------------------
   Start
   ------------------------- */
fetchCraneData();

// Load intro audio file 
loadAudioFile('sounds/opening.wav');
  </script>
</body>
</html>
